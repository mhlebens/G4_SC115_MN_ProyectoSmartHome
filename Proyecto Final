# almacenamiento en memoria
import json
usuarios = []  
dispositivos = []
estadoDispositivos = []

# cargar los usuarios desde un archivo al inicio
try:
    with open("usuarios.txt", "r") as archivo:
        usuarios = json.load(archivo)
except FileNotFoundError:
    pass  # Si el archivo no existe, simplemente seguimos con la lista vacía

def registro():
    nombre = input("Ingrese su nombre: ")
    correo = input("Ingrese su correo electrónico: ")
    pin = input("Ingrese su pin: ")
    
    print("Su nombre de la cuenta es:", nombre)
    print("Su correo electrónico es:", correo)
    print("Su pin es:", pin)
    
    return nombre, correo, pin

def registrar_usuario(usuarios):
    nombre, correo, pin = registro()

    # ver si hay registro 
    if any(usuario['nombre'] == nombre or usuario['correo'] == correo for usuario in usuarios):
        print("El usuario ya está registrado.")
    else:
        usuarios.append({'nombre': nombre, 'correo': correo, 'pin': pin})
        with open("usuarios.txt", "w") as archivo:  # guardar los usuarios en el archivo
            json.dump(usuarios, archivo)
        print("Usuario registrado con éxito.")

#loggeo
def iniciar_sesion(usuarios):
    nombre = input("Nombre: ")
    pin = input("PIN: ")

    #verificar si las credenciales coinciden con las que se hicieron
    for usuario in usuarios:
        if usuario['nombre'] == nombre and usuario['pin'] == pin:
            print("Inicio de sesión exitoso.")
            return True
        
    print("Nombre o PIN incorrecto.")
    return False

# Funciones relacionadas a los dispositivos

# Función para registrar un nuevo dispositivo
def registrar_dispositivo():
    try:
        print("Registro de nuevo dispositivo")
        dispositivo = input("Ingrese el nombre del dispositivo: ")
        estado_inicial = input("Ingrese el estado inicial (encendido/apagado): ").lower()
        
        if estado_inicial not in ["encendido", "apagado"]:
            raise ValueError("Estado inválido. Debe ser 'encendido' o 'apagado'.")
        
        dispositivos.append(dispositivo)
        estadoDispositivos.append(True if estado_inicial == "encendido" else False)
        
        print(f"Dispositivo {dispositivo} registrado exitosamente.\n")
        gestionar_dispositivos()
    except ValueError as e:
        print(f"Error: {e}")
        registrar_dispositivo()  # Volver a solicitar la entrada


# Función para gestionar los dispositivos
def gestionar_dispositivos():
    print("Gestión de dispositivos")
    try:
        if len(dispositivos) == 0:
            print("No hay dispositivos registrados.\n")
            registrar_dispositivo()
        else:
            for i, dispositivo in enumerate(dispositivos):
                estado = "encendido" if estadoDispositivos[i] else "apagado"
                print(f"{i + 1}. {dispositivo} se encuentra {estado}")
            
            seleccion = int(input("Seleccione un dispositivo o ingrese 0 para registrar uno nuevo: ")) - 1
            
            if seleccion == -1:
                registrar_dispositivo()
            else:
                cambiar_estado_dispositivo(seleccion)
    
    except ValueError:
        print("Error: Debe ingresar un número válido. Intente nuevamente.")
        gestionar_dispositivos()  # Volver a solicitar entrada al usuario
    except IndexError:
        print("Error: Selección fuera de rango. Intente nuevamente.")
        gestionar_dispositivos()  # Volver a solicitar entrada al usuario

    
# Función para cambiar el estado de un dispositivo
def cambiar_estado_dispositivo(indice):
    try:
        nuevo_estado = input("Ingrese el nuevo estado (encendido/apagado): ").lower()
        
        if nuevo_estado not in ["encendido", "apagado"]:
            raise ValueError("Estado inválido. Debe ser 'encendido' o 'apagado'.")
        
        estadoDispositivos[indice] = True if nuevo_estado == "encendido" else False
        print(f"El dispositivo {dispositivos[indice]} ahora está {nuevo_estado}.\n")
        gestionar_dispositivos()
    
    except ValueError as e:
        print(f"Error: {e}")
        cambiar_estado_dispositivo(indice)  # Volver a solicitar la entrada

# Función del menú principal
def menu_principal():
    while True:
        print("Menú Principal")
        print("1. Registrar usuario")
        print("2. Iniciar sesión")
        print("3. Salir")
        print("3. Salir")
        
        opcion = input("Seleccione una opción: ")

        if opcion == '1':
            registrar_usuario(usuarios)
        elif opcion == '2':
            if not iniciar_sesion(usuarios):
                print("Desea intentar de nuevo o registrar un nuevo usuario.")
                continuar = input("Ingrese 1 para volver a intentar o 2 para registrar un nuevo usuario: ")
                if continuar == '2':
                    registrar_usuario(usuarios)
                elif continuar == '1':
                    continue
                else:
                    print("Opción no válida.")
        elif opcion == '3':
            print("Saliendo del sistema.")
            break
        else:
            print("Opción no válida. Inténtelo de nuevo.")
menu_principal()
